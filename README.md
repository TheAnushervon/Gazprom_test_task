# Сервис учета и анализа данных с устройств

Этот проект представляет собой REST API сервис, разработанный на Python с использованием FastAPI, для сбора, хранения и анализа данных, поступающих от условных устройств. Сервис реализован в рамках выполнения тестового задания.

## Описание системы

Сервис предназначен для приема числовых данных (`x`, `y`, `z`) от различных устройств, идентифицируемых по `device_id`. Каждое полученное измерение сохраняется в базе данных PostgreSQL с привязкой к устройству и точной временной метке получения. Накопленные данные используются для последующего анализа и получения статистических характеристик.

## Технологический стек

* **Язык:** Python 3.10
* **Фреймворк:** FastAPI
* **Сервер:** Uvicorn
* **База данных:** PostgreSQL (v15)
* **ORM:** SQLAlchemy
* **Валидация данных:** Pydantic
* **Окружение и развертывание:** Docker, Docker Compose
* **Переменные окружения:** python-dotenv

## Реализованный функционал 

* **Сбор статистики:** Реализован REST API эндпоинт для приема статистики от устройства по его идентификатору `device_id`.
    * Формат принимаемой статистики: `{"x": float, "y": float, "z": float}`.
* **Хранение данных:** Полученные данные сохраняются в БД PostgreSQL с указанием `device_id` и временной метки `timestamp`.
* **Анализ статистики:** Реализованы REST API эндпоинты для анализа собранной статистики:
    * Получение статистики по `device_id` за **весь период** времени.
    * Получение статистики по `device_id` за **определенный период** с указанием `start_time` и `end_time`.
* **Результаты анализа:** Анализ включает расчет следующих числовых характеристик для каждой из величин (`x`, `y`, `z`):
    * Минимальное значение (`min`)
    * Максимальное значение (`max`)
    * Количество записей (`count`)
    * Сумма значений (`sum`)
    * Медиана (`median`)
* **Развертывание:** Сервис и его окружение (база данных PostgreSQL) полностью конфигурируются и разворачиваются с помощью Docker и Docker Compose.

## Структура проекта
```
app
├── database
│   ├── crud.py
│   ├── database.py
│   ├── models.py
|
├── docker-compose.yml
├── Dockerfile
├── main.py
├── requirements.txt
└── schemas.py
```

## Установка и запуск

Для запуска сервиса локально с использованием Docker необходимо выполнить следующие шаги:

1.  **Предварительные требования:**
    * Установленный Git
    * Установленный Docker
    * Установленный Docker Compose

2.  **Клонирование репозитория:**
    ```bash
    git clone git@github.com:TheAnushervon/Gazprom_test_task.git
    ```

3.  **Конфигурация переменных окружения:**
    * Создайте файл `.env` в корневой директории проекта.
    * Файл `.env` содержит настройки для подключения к базе данных PostgreSQL. 
    * **Важно:** Файл `.env` уже добавлен в `.gitignore`, чтобы избежать случайной отправки секретных данных в репозиторий.

4.  **Запуск сервиса:**
    * Выполните команду в корневой директории проекта:
        ```bash
        docker-compose up --build -d
        ```
        * `--build`: пересобирает образ приложения, если были изменения в коде или Dockerfile.
        * `-d`: запускает контейнеры в фоновом режиме.
    * Сервис будет доступен по адресу: `http://localhost:8000`
    * База данных PostgreSQL будет доступна внутри Docker-сети по имени `db` на порту `5432`.

5.  **Остановка сервиса:**
    ```bash
    docker-compose down
    ```
## Демонстрация работы

В папке `images/` находятся скриншоты, иллюстрирующие основные этапы взаимодействия с сервисом и результаты его работы.


## Документация API (Endpoints)

При помощи Swagger UI нам предоставляется интерактивная документацию API, которая доступна после запуска по адресу:

**`http://localhost:8000/docs`**

Основные доступные эндпоинты:

1.  **`POST /devices/{device_id}/readings/`**
    * **Описание:** Принимает и сохраняет новое измерение (`x`, `y`, `z`) для указанного устройства.
    * **Параметры пути:**
        * `device_id` (string): Идентификатор устройства.
    * **Тело запроса:**
        ```json
        {
          "x": 10.5,
          "y": -2.1,
          "z": 0.8
        }
        ```
    * **Ответ (201 Created):**
        ```json
        {
          "id": 1,
          "device_id": "some_device_id",
          "timestamp": "2025-04-05T13:39:53.123456",
          "x": 10.5,
          "y": -2.1,
          "z": 0.8
        }
        ```

2.  **`GET /devices/{device_id}/analysis`**
    * **Описание:** Возвращает статистический анализ (min, max, sum, count, median) для всех измерений указанного устройства.
    * **Параметры пути:**
        * `device_id` (string): Идентификатор устройства.
    * **Ответ (200 OK):**
        ```json
        {
          "count": 100,
          "min_x": -5.2,
          "max_x": 15.8,
          "sum_x": 512.3,
          "median_x": 5.1,
          "min_y": -10.0,
          "max_y": 12.1,
          "sum_y": 105.5,
          "median_y": 1.5,
          "min_z": -1.0,
          "max_z": 2.5,
          "sum_z": 88.9,
          "median_z": 0.9
        }

3.  **`GET /devices/{device_id}/analysis/period`**
    * **Описание:** Возвращает статистический анализ для измерений указанного устройства в заданном временном интервале.
    * **Параметры пути:**
        * `device_id` (string): Идентификатор устройства.
    * **Параметры запроса (Query):**
        * `start_time` (datetime): Начало периода (формат ISO 8601, например, `2025-04-01T00:00:00Z` или `2025-04-01T10:00:00+02:00`).
        * `end_time` (datetime): Конец периода (формат ISO 8601).
    * **Ответ (200 OK):** Структура ответа аналогична `GET /devices/{device_id}/analysis`.

4.  **`GET /health`**
    * **Описание:** Эндпоинт для проверки работоспособности сервиса и доступности соединения с базой данных.
    * **Ответ (200 OK):**
        ```json
        {
          "status": "ok",
          "database": "connected"
        }
        ```
        *(В случае проблем с БД, поле `database` будет `disconnected`)*

5.  **`GET /`**
    * **Описание:** Корневой эндпоинт, возвращает приветственное сообщение.

## Схема Базы Данных

* Данные хранятся в единственной таблице `readings` в базе данных PostgreSQL (`devicedb`).
* Структура таблицы определяется моделью SQLAlchemy в файле `database/models.py`.
* Основные колонки:
    * `id` (Integer, Primary Key)
    * `device_id` (String, Indexed)
    * `timestamp` (DateTime, Indexed)
    * `x` (Float)
    * `y` (Float)
    * `z` (Float)
* Таблица создается автоматически при первом запуске приложения с помощью `Base.metadata.create_all(engine)`. 
